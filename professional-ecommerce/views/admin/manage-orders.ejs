<%- include('../partials/header', { title: 'Manage Orders' }) %>

<div class="admin-manage-container">
    <h1>Manage Orders</h1>

    <% if (orders.length > 0) { %>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Customer</th>
                     <th>Address</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
             </thead>
            <tbody>
                <% orders.forEach(order => { %>
                    <tr>
                        <td><%= order._id %></td>
                         <td><%= order.formattedOrderDate %></td>
                         <td><%= order.userEmail %></td>
                         <td>
                            <%= order.shippingAddress.name %>, <%= order.shippingAddress.cityVillage %>, <%= order.shippingAddress.pincode %>
                         </td>
                        <td>
                            <%= order.products.map(p => `${p.name} (x${p.quantity})`).join(', ').substring(0, 50) %>...
                         </td>
                        <td>$<%= order.totalAmount.toFixed(2) %></td>
                        <td>
                             <span class="status-badge status-<%= order.status.toLowerCase().replace(/ /g, '-') %>"><%= order.status %></span>
                            <% if(order.assignedAdminEmail) { %>
                                <br><small>(Assigned: <%= order.assignedAdminEmail %>)</small>
                            <% } %>
                        </td>
                        <td class="actions-cell">
                            <% if (order.needsVerification) { %>
                                 <form action="/admin/orders/<%= order._id %>/send-otp" method="POST" class="inline-form">
                                     <button type="submit" class="btn btn-warning btn-sm" title="Send verification OTP to customer"><i class="fas fa-paper-plane"></i> Send OTP</button>
                                 </form>
                                 <form action="/admin/orders/<%= order._id %>/verify-otp" method="POST" class="inline-form verify-otp-form">
                                     <input type="text" name="otp" placeholder="Enter OTP" required size="6" pattern="\d{6}">
                                     <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-check"></i> Verify</button>
                                 </form>

                            <% } else if (order.isVerified && order.status !== 'Cancelled' && order.status !== 'Delivered') { %>
                                <span class="verified-badge"><i class="fas fa-check-circle"></i> Verified</span>
                            <% } %>

                            <% if (order.status === 'Order Received' && deliveryAdmins && deliveryAdmins.length > 0) { %>
                                <form action="/admin/orders/<%= order._id %>/assign" method="POST" class="inline-form assign-order-form">
                                    <select name="deliveryAdminId" required>
                                        <option value="" disabled selected>Assign to...</option>
                                        <% deliveryAdmins.forEach(admin => { %>
                                             <option value="<%= admin._id %>"><%= admin.email %></option>
                                        <% }) %>
                                     </select>
                                     <button type="submit" class="btn btn-info btn-sm"><i class="fas fa-shipping-fast"></i> Assign & Ship</button>
                                 </form>
                            <% } else if (order.status === 'Order Received') { %>
                                 <small class="text-danger">No delivery admins available</small>
                            <% } %>

                         </td>
                    </tr>
                <% }) %>
             </tbody>
        </table>
    <% } else { %>
        <p>No orders received yet.</p>
    <% } %>
</div>

<%- include('../partials/footer') %>
