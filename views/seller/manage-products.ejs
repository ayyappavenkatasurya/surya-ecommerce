<%# views/seller/manage-products.ejs %>
<%- include('../partials/header', { title: 'Manage My Products' }) %>

<div class="seller-manage-container container">
    <h1>Manage My Products</h1>
     <a href="/seller/upload-product" class="btn btn-primary mb-3"><i class="fas fa-plus"></i> Upload New Product</a>

   <% if (products.length > 0) { %>
       <div class="table-container card">
           <table class="data-table">
               <thead>
                   <tr>
                       <th>Image</th>
                       <th>Name / Category</th>
                       <th>Price</th>
                       <th>Stock</th>
                       <th>Status</th> <%# Added Status %>
                       <th>Rating / Sold</th>
                       <th class="actions-cell" style="text-align: right;">Actions</th>
                   </tr>
                </thead>
                <tbody>
                   <% products.forEach(product => { %>
                     <%
                        let statusClass = '';
                        let statusTooltip = '';
                        if (product.status === 'Pending Approval') {
                            statusClass = 'text-warning';
                            statusTooltip = 'Waiting for admin review';
                        } else if (product.status === 'Rejected') {
                            statusClass = 'text-danger';
                            statusTooltip = product.rejectionReason ? `Reason: ${product.rejectionReason}` : 'Rejected by admin';
                        } else if (product.status === 'Approved') {
                            statusClass = 'text-success';
                            statusTooltip = 'Live in the store';
                        }
                     %>
                       <tr>
                           <td data-label="Image">
                               <% if (product.status === 'Approved') { %>
                                <a href="/products/<%= product._id %>" target="_blank" title="View Live Product">
                                    <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="table-img">
                                </a>
                               <% } else { %>
                                <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="table-img" style="opacity: 0.7;">
                               <% } %>
                           </td>
                            <td data-label="Name / Category">
                                <%= product.name %><br>
                                <small class="text-muted"><%= product.category %></small>
                            </td>
                            <td data-label="Price">â‚¹<%= product.price.toFixed(2) %></td>
                            <td data-label="Stock"><%= product.stock %></td>
                            <td data-label="Status">
                                <span class="<%= statusClass %>" title="<%= statusTooltip %>">
                                    <strong><%= product.status %></strong>
                                </span>
                                <% if (product.status === 'Rejected' && product.rejectionReason) { %>
                                    <i class="fas fa-info-circle text-danger" title="Reason: <%= product.rejectionReason %>"></i>
                                <% } %>
                            </td>
                             <td data-label="Rating / Sold">
                                <% if (product.numReviews > 0) { %>
                                    <i class="fas fa-star text-warning"></i> <%= product.averageRating.toFixed(1) %> (<%= product.numReviews %>)
                                <% } else { %>
                                    <span class="text-muted">No Rating</span>
                                <% } %>
                                <br><small class="text-muted">Sold: <%= product.orderCount %></small>
                            </td>
                            <td data-label="Actions" class="actions-cell">
                               <%# Edit button available for all statuses (editing triggers re-approval) %>
                               <a href="/seller/manage-products/edit/<%= product._id %>" class="btn btn-text btn-sm" title="Edit Product (will require re-approval)"><i class="fas fa-edit"></i> Edit</a>

                               <%# Remove button - maybe disable if Approved and sold? For now, always allow removal %>
                               <form action="/seller/manage-products/remove/<%= product._id %>" method="POST" class="inline-form form-submit-spinner" onsubmit="return confirm('Are you sure you want to remove this product: <%= product.name %>?');">
                                    <button type="submit" class="btn btn-text btn-danger btn-sm" title="Remove Product"><i class="fas fa-trash"></i> Remove</button>
                               </form>
                           </td>
                        </tr>
                    <% }) %>
               </tbody>
            </table>
       </div>
   <% } else { %>
        <p class="alert alert-info mt-3">You haven't uploaded any products yet. <a href="/seller/upload-product">Upload your first product!</a></p>
   <% } %>
    <div class="mt-3">
        <a href="/seller/dashboard" class="btn btn-outline-secondary">Back to Seller Dashboard</a>
    </div>
</div>

<%- include('../partials/footer') %>