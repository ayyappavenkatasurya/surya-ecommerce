<%# views/products/index.ejs %>
<%- include('../partials/header', { title: title }) %>

<%# --- Conditionally Display Banner Slider --- %>
<%# Only show the banner if NO category is selected %>
<% if (!selectedCategory) { %>
    <%# --- Homepage Banner Slider Section (Original Check) --- %>
    <% if (typeof homepageBanners !== 'undefined' && homepageBanners.length > 0) { %>
        <div class="banner-slider-container mb-4" data-slider-container>
            <div class="banner-slides" data-slides>
                <% homepageBanners.forEach((banner, index) => { %>
                    <div class="banner-slide <%= index === 0 ? 'active' : '' %>" data-slide>
                        <% if (banner.linkUrl) { %>
                            <a href="<%= banner.linkUrl %>" rel="noopener noreferrer" class="banner-link">
                                <img src="<%= banner.imageUrl %>"
                                     alt="<%= banner.title || `Promotional Banner ${index + 1}` %>"
                                     class="banner-image"
                                     loading="lazy">
                            </a>
                        <% } else { %>
                            <img src="<%= banner.imageUrl %>"
                                 alt="<%= banner.title || `Promotional Banner ${index + 1}` %>"
                                 class="banner-image"
                                 loading="lazy">
                        <% } %>
                    </div>
                <% }) %>
            </div>

            <%# Optional: Navigation Arrows %>
            <% if (homepageBanners.length > 1) { %>
                <button class="banner-nav banner-prev" data-slider-prev aria-label="Previous Banner"><i class="fas fa-chevron-left"></i></button>
                <button class="banner-nav banner-next" data-slider-next aria-label="Next Banner"><i class="fas fa-chevron-right"></i></button>
            <% } %>

            <%# Optional: Navigation Dots %>
             <% if (homepageBanners.length > 1) { %>
                <div class="banner-dots" data-slider-dots>
                    <% homepageBanners.forEach((_, index) => { %>
                        <button class="banner-dot <%= index === 0 ? 'active' : '' %>" data-slide-to="<%= index %>" aria-label="Go to banner <%= index + 1 %>"></button>
                    <% }) %>
                </div>
            <% } %>
        </div>
    <% } %>
    <%# --- End: Homepage Banner Slider Section --- %>
<% } %> <%# End of the check for !selectedCategory %>


<%# --- Category Icons Section (Always shows if categories exist) --- %>
<% if (typeof displayCategories !== 'undefined' && displayCategories.length > 0) { %>
    <div class="category-icons-section mb-4">
        <h2 class="text-center mb-3">Shop by Category</h2>
        <div class="category-grid">
            <% displayCategories.forEach(cat => { %>
                <% let categoryUrl = '/?category=' + encodeURIComponent(cat.name); %>
                <% if (typeof searchTerm !== 'undefined' && searchTerm) { categoryUrl += '&search=' + encodeURIComponent(searchTerm); } %>
                <a href="<%= categoryUrl %>" class="category-item <%= (typeof selectedCategory !== 'undefined' && selectedCategory === cat.name) ? 'active' : '' %>" title="Shop <%= cat.name %>">
                    <div class="category-icon-wrapper">
                         <img src="<%= cat.iconUrl %>" alt="<%= cat.name %> Icon" class="category-icon" loading="lazy">
                    </div>
                    <span class="category-name"><%= cat.name %></span>
                </a>
            <% }) %>
        </div>
    </div>
<% } %>
<%# --- End: Category Icons Section --- %>


<div class="product-index-container">
     <%# Display title based on filter/search %>
     <% if (selectedCategory) { %>
         <h1 class="mb-3">Category: <%= selectedCategory %></h1>
         <p class="mb-3"><a href="/">« Back to All Products</a></p>
     <% } else if (searchTerm) { %>
         <h1 class="mb-3">Search Results for "<%= searchTerm %>"</h1>
     <% } else { %>
          <h1 class="mb-3">New Launches</h1>
     <% } %>


    <% if (products.length > 0) { %>
        <div class="product-grid">
            <% products.forEach(product => { %>
                <div class="product-card">
                    <a href="/products/<%= product._id %>" class="product-link">
                        <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="product-image">
                        <div class="product-info">
                            <h3 class="product-name"><%= product.name %></h3>
                            <p class="product-price">₹<%= (typeof product.price === 'number' ? product.price : 0).toFixed(2) %></p>
                            <p class="product-stock">Stock: <%= product.stock %></p>
                            <% if (product.numReviews > 0) { %>
                                 <p class="product-rating">
                                    <% for(let i=1; i<=5; i++) { %>
                                        <i class="fas fa-star<%= i <= product.averageRating ? '' : (i - 0.5 <= product.averageRating ? '-half-alt' : '-regular') %>"></i>
                                    <% } %>
                                    (<%= product.numReviews %>)
                                 </p>
                            <% } else { %>
                                <p class="product-rating"> </p> <%# Keep space for alignment %>
                            <% } %>
                        </div>
                    </a>
                     <form action="/user/cart/add" method="POST" class="add-to-cart-form form-submit-spinner">
                         <input type="hidden" name="productId" value="<%= product._id %>">
                         <input type="hidden" name="quantity" value="1">
                        <button type="submit" class="btn btn-primary btn-add-to-cart" <%= product.stock <= 0 ? 'disabled' : '' %>>
                            <i class="fas fa-cart-plus"></i> <%= product.stock <= 0 ? 'Out of Stock' : 'Add to Cart' %>
                         </button>
                    </form>
                </div>
            <% }) %>
        </div>
    <% } else { %>
         <p class="alert alert-info">
             <% if (typeof searchTerm !== 'undefined' && searchTerm) { %>
                 No products found matching your search "<%= searchTerm %>". <a href="/">View all products?</a>
             <% } else if (typeof selectedCategory !== 'undefined' && selectedCategory) { %>
                 No products found in the category "<%= selectedCategory %>". <a href="/">View all categories?</a>
             <% } else { %>
                 No products are currently available. Check back soon!
             <% } %>
         </p>
    <% } %>

</div>

<%- include('../partials/footer') %>