<%# views/products/index.ejs %>
<%- include('../partials/header', { title: title }) %>

<%# --- Category Icons Section (Uses new CSS) --- %>
<% if (typeof displayCategories !== 'undefined' && displayCategories.length > 0) { %>
    <div class="category-icons-section mb-4">
        <div class="category-grid">
            <% displayCategories.forEach(cat => { %>
                <% let categoryUrl = '/?category=' + encodeURIComponent(cat.name); %>
                <%# Keep search term if user is filtering category *after* a search %>
                <% if (typeof searchTerm !== 'undefined' && searchTerm) { categoryUrl += '&search=' + encodeURIComponent(searchTerm); } %>
                <a href="<%= categoryUrl %>"
                   class="category-item <%= (typeof selectedCategory !== 'undefined' && selectedCategory === cat.name) ? 'active' : '' %>"
                   title="Shop <%= cat.name %>">
                    <div class="category-icon-wrapper">
                         <img src="<%= cat.iconUrl %>"
                              alt="<%= cat.name %> Icon"
                              class="category-icon"
                              loading="lazy">
                    </div>
                    <span class="category-name"><%= cat.name %></span>
                </a>
            <% }) %>
        </div>
    </div>
<% } %>
<%# --- End: Category Icons Section --- %>


<%# --- Conditionally Display Banner Slider --- %>
<%# Only show the banner if NO category is selected AND NO search term is present %>
<% if (!selectedCategory && (!searchTerm || searchTerm.trim() === '')) { %>
    <% if (typeof homepageBanners !== 'undefined' && homepageBanners.length > 0) { %>
        <div class="banner-slider-container mb-4" data-slider-container>
            <%# --- ADDED WRAPPER --- %>
            <div class="banner-slides-wrapper" data-slides-wrapper>
                <% homepageBanners.forEach((banner, index) => { %>
                    <%# Slide content remains the same, REMOVE active class %>
                    <div class="banner-slide" data-slide>
                        <% if (banner.linkUrl) { %>
                            <a href="<%= banner.linkUrl %>" rel="noopener noreferrer" class="banner-link">
                                <img src="<%= banner.imageUrl %>"
                                     alt="<%= banner.title || `Promotional Banner ${index + 1}` %>"
                                     class="banner-image"
                                     loading="lazy">
                            </a>
                        <% } else { %>
                            <img src="<%= banner.imageUrl %>"
                                 alt="<%= banner.title || `Promotional Banner ${index + 1}` %>"
                                 class="banner-image"
                                 loading="lazy">
                        <% } %>
                    </div>
                <% }) %>
                 <%# JS will add cloned slides here %>
            </div>
            <%# --- END ADDED WRAPPER --- %>

            <%# Optional: Navigation Arrows (keep outside wrapper) - Hidden initially by CSS %>
            <% if (homepageBanners.length > 1) { %>
                <button class="banner-nav banner-prev" data-slider-prev aria-label="Previous Banner"><i class="fas fa-chevron-left"></i></button>
                <button class="banner-nav banner-next" data-slider-next aria-label="Next Banner"><i class="fas fa-chevron-right"></i></button>
            <% } %>

            <%# Optional: Navigation Dots (keep outside wrapper) - Hidden initially by CSS %>
             <% if (homepageBanners.length > 1) { %>
                <div class="banner-dots" data-slider-dots>
                    <% homepageBanners.forEach((_, index) => { %>
                         <%# Remove active class, JS will handle it %>
                        <button class="banner-dot" data-slide-to="<%= index %>" aria-label="Go to banner <%= index + 1 %>"></button>
                    <% }) %>
                </div>
            <% } %>
        </div>
    <% } %>
<% } %>
<%# --- End: Homepage Banner Slider Section --- %>


<div class="product-index-container">
     <%# Display title based on filter/search %>
     <% if (selectedCategory) { %>
         <h1 class="mb-3"><%= selectedCategory %> Products</h1>
     <% } else if (searchTerm) { %>
         <h1 class="mb-3">Search Results for "<%= searchTerm %>"</h1>
     <% } else { %>
          <%# Only show "New Launches" if neither category nor search is active %>
          <h1 class="mb-3">New Launches</h1>
     <% } %>


    <%# Check if products array exists and has items %>
    <% if (typeof products !== 'undefined' && products.length > 0) { %>
        <div class="product-grid">
            <% products.forEach(product => { %>
                <%# Ensure product and its properties exist before accessing %>
                <% if (product && product._id && product.name && product.imageUrl && typeof product.price !== 'undefined' && typeof product.stock !== 'undefined') { %>
                    <div class="product-card">
                        <a href="/products/<%= product._id %>" class="product-link">
                            <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="product-image" loading="lazy"> <%# Added lazy loading %>
                            <div class="product-info">
                                <h3 class="product-name"><%= product.name %></h3>
                                <p class="product-price">â‚¹<%= (typeof product.price === 'number' ? product.price : 0).toFixed(2) %></p>
                                <p class="product-stock">Stock: <%= product.stock %></p>
                                <%# Display Rating %>
                                <% const numReviews = product.numReviews || 0; %>
                                <% const averageRating = product.averageRating || 0; %>
                                <% if (numReviews > 0) { %>
                                     <p class="product-rating">
                                        <% for(let i=1; i<=5; i++) { %>
                                            <i class="fas fa-star<%= i <= averageRating ? '' : (i - 0.5 <= averageRating ? '-half-alt' : '-regular') %>"></i>
                                        <% } %>
                                        (<%= numReviews %>)
                                     </p>
                                <% } else { %>
                                    <p class="product-rating" style="height: 1.2em;"> </p> <%# Keep space for alignment if no rating %>
                                <% } %>
                            </div>
                        </a>
                         <form action="/user/cart/add" method="POST" class="add-to-cart-form form-submit-spinner">
                             <input type="hidden" name="productId" value="<%= product._id %>">
                             <input type="hidden" name="quantity" value="1">
                            <button type="submit" class="btn btn-primary btn-add-to-cart" <%= product.stock <= 0 ? 'disabled' : '' %>>
                                <i class="fas fa-cart-plus"></i> <%= product.stock <= 0 ? 'Out of Stock' : 'Add to Cart' %>
                             </button>
                        </form>
                    </div>
                <% } %>
            <% }) %>
        </div>
    <% } else { %>
         <%# Display message if no products match filters or none exist %>
         <p class="alert alert-info mt-3"> <%# Added margin-top %>
             <% if (typeof searchTerm !== 'undefined' && searchTerm) { %>
                 No products found matching your search "<%= searchTerm %>". <a href="/" class="alert-link">Check back soon!</a>
             <% } else if (typeof selectedCategory !== 'undefined' && selectedCategory) { %>
                 No products found in the category "<%= selectedCategory %>". <a href="/" class="alert-link">Check back soon!</a>
             <% } else { %>
                 No products are currently available. Check back soon!
             <% } %>
         </p>
    <% } %>

</div>

<%- include('../partials/footer') %>