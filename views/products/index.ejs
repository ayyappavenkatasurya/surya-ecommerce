<%# views/products/index.ejs %>
<%- include('../partials/header', { title: title }) %>

<%# --- Banner Slider --- %>
<% if (typeof homepageBanners !== 'undefined' && homepageBanners.length > 0) { %>
    <div class="banner-slider-container mb-4" data-slider-container>
        <div class="banner-slides" data-slides>
             <% homepageBanners.forEach((banner, index) => { %>
                <div class="banner-slide <%= index === 0 ? 'active' : '' %>" data-slide>
                     <% if (banner.linkUrl) { %>
                        <a href="<%= banner.linkUrl %>" rel="noopener noreferrer" class="banner-link">
                            <img src="<%= banner.imageUrl %>" alt="<%= banner.title || `Promotional Banner ${index + 1}` %>" class="banner-image" loading="lazy">
                        </a>
                    <% } else { %>
                         <img src="<%= banner.imageUrl %>" alt="<%= banner.title || `Promotional Banner ${index + 1}` %>" class="banner-image" loading="lazy">
                     <% } %>
                </div>
             <% }) %>
         </div>
        <% if (homepageBanners.length > 1) { %><button class="banner-nav banner-prev" data-slider-prev aria-label="Previous Banner"><i class="fas fa-chevron-left"></i></button><button class="banner-nav banner-next" data-slider-next aria-label="Next Banner"><i class="fas fa-chevron-right"></i></button><% } %>
         <% if (homepageBanners.length > 1) { %><div class="banner-dots" data-slider-dots><% homepageBanners.forEach((_, index) => { %><button class="banner-dot <%= index === 0 ? 'active' : '' %>" data-slide-to="<%= index %>" aria-label="Go to banner <%= index + 1 %>"></button><% }) %></div><% } %>
    </div>
<% } %>

<%# --- Dynamic Categories Section --- %>
<% if (typeof homepageCategories !== 'undefined' && homepageCategories.length > 0) { %>
    <div class="category-display-section mb-4">
        <h2 class="h4">Categories</h2>
        <div class="category-grid">
            <% homepageCategories.forEach(category => { %>
                <%# --- MODIFICATION: Added conditional 'active-category' class --- %>
                <a href="/products?categoryName=<%= encodeURIComponent(category.name) %>"
                   class="category-card <%= (typeof selectedCategoryName !== 'undefined' && selectedCategoryName === category.name) ? 'active-category' : '' %>"
                   title="Shop <%= category.name %>">
                    <div class="category-image-wrapper">
                         <img src="<%= category.imageUrl %>" alt="<%= category.name %>" class="category-image" loading="lazy">
                    </div>
                    <span class="category-name"><%= category.name %></span>
                 </a>
            <% }) %>
         </div>
     </div>
 <% } %>
<%# --- End: Dynamic Categories Section --- %>


<div class="product-index-container">
    <%# Update heading based on context %>
    <h1 class="h2 mb-3"> <%# Used h2 for better hierarchy %>
        <% if (selectedCategoryName) { %>
            <%= title %> <%# Already contains "Products in Category" %>
         <% } else if (searchTerm) { %>
            <%= title %> <%# Already contains "Search Results" %>
        <% } else { %>
             New Launches <%# Default homepage title %>
         <% } %>
     </h1>

    <% if (products.length > 0) { %>
        <div class="product-grid">
            <% products.forEach(product => { %>
                <div class="product-card">
                     <a href="/products/<%= product._id %>" class="product-link">
                        <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="product-image" loading="lazy">
                        <div class="product-info">
                             <h3 class="product-name"><%= product.name %></h3>
                            <p class="product-category small text-muted"><%= product.categoryName %></p> <%# Display category name %>
                             <p class="product-price">â‚¹<%= (typeof product.price === 'number' ? product.price : 0).toFixed(2) %></p>
                            <% if (product.stock > 0) { %>
                                <p class="product-stock small">Stock: <%= product.stock %></p>
                            <% } else { %>
                                <p class="product-stock small text-danger fw-bold">Out of Stock</p>
                            <% } %>
                            <% if (product.numReviews > 0) { %>
                                 <p class="product-rating small">
                                     <% for(let i=1; i<=5; i++) { %><i class="fas fa-star<%= i <= product.averageRating ? '' : (i - 0.5 <= product.averageRating ? '-half-alt' : '-regular') %>"></i><% } %>
                                     (<%= product.numReviews %>)
                                  </p>
                             <% } else { %>
                                 <p class="product-rating small"> </p> <%# Keep empty p for structure %>
                             <% } %>
                         </div>
                     </a>
                     <form action="/user/cart/add" method="POST" class="add-to-cart-form form-submit-spinner">
                         <input type="hidden" name="productId" value="<%= product._id %>">
                         <input type="hidden" name="quantity" value="1">
                        <button type="submit" class="btn btn-primary btn-add-to-cart" <%= product.stock <= 0 ? 'disabled' : '' %>>
                            <i class="fas fa-cart-plus"></i> <%= product.stock <= 0 ? 'Out of Stock' : 'Add to Cart' %>
                         </button>
                    </form>
                 </div>
            <% }) %>
        </div>
    <% } else { %>
         <p class="alert alert-info">
              <% if (typeof searchTerm !== 'undefined' && searchTerm) { %>
                  No products found matching your search "<%= searchTerm %>".
             <% } else if (typeof selectedCategoryName !== 'undefined' && selectedCategoryName) { %>
                 No products found in the category "<%= selectedCategoryName %>".
              <% } else { %>
                  No products are currently available. Check back soon!
             <% } %>
         </p>
    <% } %>
</div>

<%- include('../partials/footer') %>