<%# views/products/detail.ejs %>
<%- include('../partials/header', {
    title: product.name,
    metaTitle: product.name + ' - ' + defaultSiteName,
    metaDescription: (product.shortDescription || `Check out ${product.name} on miniapp. Available now for ₹${product.price.toFixed(2)}.`).substring(0, 157) + '...',
    metaImageUrl: product.imageUrl, // Use primary image for meta tags
    metaUrl: fullUrl,
    metaType: 'product'
}) %>

<div class="product-detail-container">

   <%# --- Status Banner --- %>
   <% if (!isApproved && (isAdminView || isOwnerView)) { %>
     <div class="alert alert-<%= product.reviewStatus === 'rejected' ? 'danger' : 'warning' %> mb-3" role="alert">
       <strong>Status:</strong> <span class="text-capitalize fw-bold"><%= product.reviewStatus %></span>
       <% if (product.reviewStatus === 'rejected' && product.rejectionReason) { %>
         <br><strong>Reason:</strong> <%= product.rejectionReason %>
       <% } else if (product.reviewStatus === 'pending') { %>
          - This product is awaiting review and is not visible to customers.
       <% } %>
       <% if (isOwnerView && product.reviewStatus !== 'approved') { %>
          <br><a href="/seller/products/edit/<%= product._id %>" class="alert-link">Edit and Resubmit for Review</a>
        <% } else if (isAdminView && product.reviewStatus !== 'approved') { %>
           <br><a href="/admin/manage-products/edit/<%= product._id %>" class="alert-link">Admin: Edit Status/Details</a>
       <% } %>
     </div>
   <% } else if (!isApproved && !isAdminView && !isOwnerView) { %>
      <div class="alert alert-danger">This product is currently unavailable.</div>
      </div> <%# Close container early if unavailable %>
      <%- include('../partials/footer') %>
      <% return; %>
   <% } %>

   <div class="product-detail-main">
        <%# --- Image Display Logic --- %>
        <div class="product-detail-image-section"> <%# Wrapper section %>
            <% if (product.imageUrl2) { %>
                <%# Slider structure if two images exist %>
                <div class="product-image-slider-container" data-product-image-slider>
                    <div class="product-image-slides">
                        <div class="product-image-slide active" data-product-slide>
                            <img src="<%= product.imageUrl %>" alt="<%= product.name %> - Image 1" class="product-detail-image">
                        </div>
                        <div class="product-image-slide" data-product-slide>
                             <img src="<%= product.imageUrl2 %>" alt="<%= product.name %> - Image 2" class="product-detail-image">
                        </div>
                    </div>
                    <%# Navigation Arrows only if there are slides to navigate %>
                    <button class="product-image-nav product-image-prev" data-product-image-nav="prev" aria-label="Previous Image">‹</button>
                    <button class="product-image-nav product-image-next" data-product-image-nav="next" aria-label="Next Image">›</button>
                    <%# Navigation Dots only if there are slides to navigate %>
                     <div class="product-image-dots">
                         <button class="product-image-dot active" data-product-image-dot="0" aria-label="Go to image 1"></button>
                         <button class="product-image-dot" data-product-image-dot="1" aria-label="Go to image 2"></button>
                     </div>
                </div>
            <% } else { %>
                <%# Original single image display if only one image %>
                <div class="product-detail-image-single"> <%# Optional wrapper %>
                    <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="product-detail-image">
                </div>
            <% } %>
        </div>
        <%# --- END Image Display Logic --- %>

       <div class="product-detail-info">
            <h1><%= product.name %></h1>
            <% if (product.shortDescription) { %>
              <p class="product-short-description text-muted mb-2"><%= product.shortDescription %></p>
            <% } %>
            <p class="detail-price">₹<%= product.price.toFixed(2) %></p>
            <p class="detail-stock">
                <% if (product.stock > 0) { %>
                    Available Stock : <%= product.stock %>
                <% } else { %>
                    <span class="text-danger fw-bold">Out of Stock</span>
                <% } %>
            </p>

            <%# Share Button %>
            <div class="share-section mt-2">
                 <button id="share-product-btn" class="btn btn-outline-secondary btn-sm"
                         data-title="<%= product.name %>"
                         data-text="Check out this product: <%= product.name %>"
                         data-url="<%= fullUrl %>">
                     <i class="fas fa-share-alt"></i> Share
                 </button>
                 <div id="fallback-share-links" class="fallback-share-links hidden">
                     <small>Share via:</small>
                     <a href="https://www.facebook.com/sharer/sharer.php?u=<%= encodeURIComponent(fullUrl) %>" target="_blank" rel="noopener noreferrer" aria-label="Share on Facebook"><i class="fab fa-facebook-square"></i></a>
                     <a href="https://twitter.com/intent/tweet?url=<%= encodeURIComponent(fullUrl) %>&text=<%= encodeURIComponent('Check out this product: ' + product.name) %>" target="_blank" rel="noopener noreferrer" aria-label="Share on Twitter"><i class="fab fa-twitter-square"></i></a>
                     <a href="https://api.whatsapp.com/send?text=<%= encodeURIComponent('Check out this product: ' + product.name + ' ' + fullUrl) %>" target="_blank" rel="noopener noreferrer" aria-label="Share on WhatsApp"><i class="fab fa-whatsapp-square"></i></a>
                     <a href="mailto:?subject=<%= encodeURIComponent('Check out this product: ' + product.name) %>&body=<%= encodeURIComponent('I thought you might like this product:\n\n' + product.name + '\n' + fullUrl) %>" aria-label="Share via Email"><i class="fas fa-envelope-square"></i></a>
                 </div>
             </div>

           <%# --- Conditional Purchase Actions START --- %>
           <% if (isApproved) { %>
               <div class="product-actions mt-3"> <%# Added margin-top %>
                   <%# --- WRAP actions in a flex container --- %>
                   <div class="d-flex flex-wrap align-items-center gap-2"> <%# flex-wrap allows buttons to stack on small screens if needed %>

                       <%# Add to Cart Form (remains mostly the same, but button is moved out) %>
                       <form action="/user/cart/add" method="POST" id="add-to-cart-form-<%= product._id %>" class="form-submit-spinner">
                          <input type="hidden" name="productId" value="<%= product._id %>">
                           <%# Quantity selector now inside the flex container %>
                           <div class="quantity-selector d-inline-flex align-items-center me-2"> <%# Added display: inline-flex %>
                               <label for="quantity-<%= product._id %>" class="me-1 mb-0 text-muted small">Qty:</label>
                               <input type="number"
                                      id="quantity-<%= product._id %>"
                                      name="quantity"
                                      value="1"
                                      min="1"
                                      max="<%= product.stock %>"
                                      required
                                      aria-label="Quantity"
                                      class="form-control form-control-sm"
                                      style="width: 65px;">
                           </div>
                       </form>

                       <%# Add to Cart Button (associated with the form above) %>
                       <button type="submit"
                               form="add-to-cart-form-<%= product._id %>" <%# Associate with form %>
                               class="btn btn-primary btn-sm btn-action" <%# Added common class btn-action %>
                               <%= product.stock <= 0 ? 'disabled' : '' %>>
                           <i class="fas fa-cart-plus"></i> <%= product.stock <= 0 ? 'Out of Stock' : 'Add to Cart' %>
                       </button>

                        <%# Buy Now Form (remains mostly the same, but button is moved out) %>
                        <% if (product.stock > 0) { %>
                        <form action="/user/cart/add?redirectTo=checkout" method="POST" id="buy-now-form-<%= product._id %>" class="form-submit-spinner">
                              <input type="hidden" name="productId" value="<%= product._id %>">
                              <input type="hidden" name="quantity" value="1"> <%# Default Buy Now to 1 %>
                           </form>
                            <%# Buy Now Button (associated with the form above) %>
                           <button type="submit"
                                   form="buy-now-form-<%= product._id %>" <%# Associate with form %>
                                   class="btn btn-success btn-sm btn-action"> <%# Added common class btn-action %>
                                   Buy Now
                           </button>
                        <% } else {%>
                          <button class="btn btn-success btn-sm btn-action" disabled>Buy Now</button> <%# Added common class btn-action %>
                        <% } %>

                   </div> <%# --- End flex container --- %>
               </div>
            <% } else { %>
                <%# Unavailable state buttons %>
                <div class="product-actions mt-3"> <%# Added margin-top %>
                     <div class="d-flex flex-wrap align-items-center gap-2"> <%# Use flex container here too for consistency %>
                         <button class="btn btn-primary btn-sm btn-action" disabled><i class="fas fa-cart-plus"></i> Add to Cart</button>
                         <button class="btn btn-success btn-sm btn-action" disabled>Buy Now</button>
                     </div>
                     <p class="text-muted small mt-2">This product is currently under review or unavailable.</p>
                 </div>
            <% } %>
            <%# --- Conditional Purchase Actions END --- %>


            <%# Specifications %>
            <div class="product-specifications mt-3">
                 <h3>Specifications</h3>
                 <pre class="border p-2 bg-light small"><%= product.specifications || 'No specifications provided.' %></pre>
            </div>

            <%# Seller Info %>
            <p class="small text-muted mt-3">Seller Info : <%= product.sellerEmail || 'Unknown Seller' %></p>

            <%# Rating Display %>
            <div class="mb-3 mt-2"> <%# Adjusted margin slightly %>
                 <% if (product.numReviews > 0) { %>
                     <p class="detail-rating">
                         Rating:
                        <% for(let i=1; i<=5; i++) { %><i class="fas fa-star<%= i <= product.averageRating ? '' : (i - 0.5 <= product.averageRating ? '-half-alt' : '-regular') %>"></i><% } %>
                         (<%= product.numReviews %> reviews) | <%= product.orderCount %> Ordered
                     </p>
                 <% } else { %>
                     <p class="detail-rating">No reviews yet | <%= product.orderCount %> Ordered</p>
                 <% } %>
             </div>

       </div> <%# End product-detail-info %>
    </div> <%# End product-detail-main %>

   <%# Conditional Rating Section (User Input) %>
   <div class="product-rating-section mt-4 border-top pt-3">
        <h3>Rate This Product</h3>
        <% if (isApproved) { %>
            <% if (userCanRate) { %>
                <form action="/products/<%= product._id %>/rate" method="POST" class="form-submit-spinner">
                    <div class="rating-stars">
                        <% for (let i = 5; i >= 1; i--) { %><input type="radio" id="star<%= i %>" name="rating" value="<%= i %>" <%= userRating === i ? 'checked' : '' %> required><label for="star<%= i %>" title="<%= i %> stars"><i class="fas fa-star"></i></label><% } %>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Submit Rating</button>
                </form>
            <% } else { %>
               <p><a href="/auth/login?returnTo=<%= encodeURIComponent(currentUrl) %>">Login</a> to rate this product.</p>
            <% } %>
         <% } else { %>
             <p class="text-muted">Rating is unavailable until the product is approved.</p>
         <% } %>
   </div>

    <%# Rating Stats Display (Summary) %>
    <div class="rating-stats-container mt-4 border-top pt-3">
        <h3>Ratings & Reviews Summary</h3>
         <% if (totalRatings > 0) { %>
             <div class="rating-summary mb-3">
                 <div class="rating-average">
                     <span class="rating-average-value"><%= product.averageRating.toFixed(1) %></span> <i class="fas fa-star text-warning"></i>
                 </div>
                 <div class="rating-total text-muted small">
                     Based on <%= totalRatings %> Rating<%= totalRatings !== 1 ? 's' : '' %>
                 </div>
             </div>
            <div class="rating-bars">
                <% for (let i = 5; i >= 1; i--) {
                      const count = ratingCounts[i] || 0;
                      const percentage = totalRatings > 0 ? (count / totalRatings) * 100 : 0;
                 %>
                     <div class="rating-bar-row">
                         <span class="rating-bar-label small"><%= i %> <i class="fas fa-star text-warning"></i></span>
                         <div class="rating-bar-progress progress" style="height: 8px;">
                             <div class="rating-bar-fill progress-bar bg-success" role="progressbar" data-width="<%= percentage.toFixed(1) %>" aria-valuenow="<%= percentage.toFixed(1) %>" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                         </div>
                         <span class="rating-bar-count small text-muted"><%= count %></span>
                     </div>
                 <% } %>
            </div>
        <% } else { %>
            <p>No ratings yet for this product.</p>
         <% } %>
    </div>

</div> <%# End product-detail-container %>


<script>
    // --- Image Slider JS ---
    const imageSlider = document.querySelector('[data-product-image-slider]');
    if (imageSlider) {
        const slides = imageSlider.querySelectorAll('[data-product-slide]');
        const prevBtn = imageSlider.querySelector('[data-product-image-nav="prev"]');
        const nextBtn = imageSlider.querySelector('[data-product-image-nav="next"]');
        const dots = imageSlider.querySelectorAll('[data-product-image-dot]');
        let currentImageIndex = 0;

        function showProductImage(index) {
            if (!slides || slides.length < 2) return; // Ensure slider elements exist and there's > 1 slide

            // Calculate the new index correctly handling negative numbers
            const newIndex = (index % slides.length + slides.length) % slides.length;

            // Update active classes for slides and dots
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === newIndex);
            });
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === newIndex);
            });

            currentImageIndex = newIndex;
        }

        // Add event listeners if buttons/dots exist
        if (nextBtn) {
            nextBtn.addEventListener('click', () => showProductImage(currentImageIndex + 1));
        }
        if (prevBtn) {
            prevBtn.addEventListener('click', () => showProductImage(currentImageIndex - 1));
        }

        dots.forEach(dot => {
            dot.addEventListener('click', () => {
                const index = parseInt(dot.dataset.productImageDot, 10);
                if (!isNaN(index)) {
                    showProductImage(index);
                }
            });
        });

        // Initialize the slider to the first image
        if (slides.length > 0) {
             showProductImage(0);
        }
    }
    // --- END Image Slider JS ---

    // --- Rating Bar Animation JS ---
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.rating-bar-fill').forEach(function(el) {
            var width = el.getAttribute('data-width');
            if (width) {
                setTimeout(() => {
                     el.style.width = width + '%';
                }, 100); // Slight delay for effect
            }
        });
    });
    // --- END Rating Bar Animation JS ---
</script>

<%- include('../partials/footer') %>