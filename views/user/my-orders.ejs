<%# views/user/my-orders.ejs %>
<%- include('../partials/header', { title: 'My Orders' }) %>

<div class="my-orders-container">
    <h1>My Orders</h1>

    <% if (orders.length > 0) { %>
        <div class="order-list">
            <% orders.forEach(order => { %>
                <div class="order-card status-<%= order.status.toLowerCase().replace(/ /g, '-') %>">
                     <div class="order-header">
                         <div><strong>Order ID:</strong> <%= order._id %></div>
                         <%# Use formatDateIST helper %>
                        <div><strong>Placed on:</strong> <%= formatDateIST(order.orderDate) %></div>
                         <div><strong>Total:</strong> â‚¹<%= order.totalAmount.toFixed(2) %></div>
                         <div><strong>Status:</strong> <span class="order-status"><%= order.status %></span></div>
                     </div>
                    <div class="order-body">
                         <div class="order-items-preview">
                             <% order.products.slice(0, 3).forEach(item => { %>
                                <% if (item.productId && item.imageUrl) { %>
                                    <a href="/products/<%= item.productId %>" title="<%= item.name %> (Qty: <%= item.quantity %>)">
                                        <img src="<%= item.imageUrl %>" alt="<%= item.name %>">
                                    </a>
                                <% } %>
                             <% }) %>
                             <% if(order.products.length > 3) { %><span class="more-items">+ <%= order.products.length - 3 %> more</span><% } %>
                        </div>
                        <div class="order-details">
                             <p><strong>Shipping To:</strong> <%= order.shippingAddress.name %>, <%= order.shippingAddress.cityVillage %>, Pin: <%= order.shippingAddress.pincode %></p>
                             <%# Use formatDateIST helper %>
                             <p><strong>Delivered On:</strong> <%= formatDateIST(order.receivedByDate) %></p>
                              <% if (order.status === 'Cancelled' && order.cancellationReason) { %>
                                <p class="text-danger"><small><strong>Reason:</strong> <%= order.cancellationReason %></small></p>
                              <% } %>
                         </div>
                    </div>
                     <div class="order-actions">
                        <% if (order.isCancellable) { %>
                            <form action="/orders/cancel/<%= order._id %>" method="POST" onsubmit="return confirm('Are you sure you want to cancel this order?');" class="form-submit-spinner">
                                <button type="submit" class="btn btn-danger btn-sm">Cancel Order</button>
                             </form>
                         <% } else if (order.status === 'Pending') { %>
                             <small class="text-muted">Cancellation window closed or processing.</small>
                         <% } else if (order.status === 'Delivered') { %>
                              <small class="text-success">Order delivered.</small>
                         <% } else if (order.status === 'Cancelled') { %>
                              <small class="text-danger">Order was cancelled.</small>
                         <% } %>
                     </div>
                </div>
            <% }) %>
        </div>
    <% } else { %>
        <p>You haven't placed any orders yet. <a href="/">Start Shopping!</a></p>
    <% } %>
</div>

<%- include('../partials/footer') %>