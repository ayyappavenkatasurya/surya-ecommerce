<%# views/user/checkout.ejs %>
<%- include('../partials/header', { title: 'Checkout' }) %>

<div class="checkout-container">
    <h1>Checkout</h1>

    <div class="checkout-grid">
        <div class="checkout-address">
            <h2>Shipping Address</h2>
            <%# Display Saved Address %>
            <div class="saved-address <%= (!userAddress || !userAddress.name) ? 'hidden' : '' %>">
                <% if (userAddress && userAddress.name) { %>
                    <p><strong><%= userAddress.name %></strong></p>
                    <p><%= userAddress.phone %></p>
                    <p><%= userAddress.landmarkNearby ? userAddress.landmarkNearby + ', ' : '' %><%= userAddress.cityVillage %>,
                        <% if (userAddress.mandal) { %><%= userAddress.mandal %>, <% } %>
                        <% if (userAddress.district) { %><%= userAddress.district %>, <% } %>
                        <% if (userAddress.state) { %><%= userAddress.state %> - <% } %>
                        <%= userAddress.pincode %>
                    </p>
                    <button type="button" id="edit-address-btn" class="btn btn-secondary btn-sm mt-2">Edit Address</button>
                <% } %>
            </div>

            <%# Address Form %>
            <form action="/user/address/save" method="POST" id="address-form" class="address-form <%= (userAddress && userAddress.name) ? 'hidden' : '' %> form-submit-spinner">
                <h3 class="h5"><%= (userAddress && userAddress.name) ? 'Edit Address' : 'Add Shipping Address' %></h3> <%# Adjusted title %>
                 <input type="hidden" name="source" value="checkout"> <%# Keep source %>

                 <div class="form-group">
                     <label for="checkout-name-addr" class="form-label small">Full Name:</label> <%# Changed ID %>
                     <input type="text" id="checkout-name-addr" name="name" class="form-control" value="<%= userAddress?.name || '' %>" required autocomplete="name">
                 </div>
                 <div class="form-group">
                     <label for="checkout-phone" class="form-label small">Phone Number:</label> <%# Changed ID %>
                     <input type="tel" id="checkout-phone" name="phone" class="form-control" value="<%= userAddress?.phone || '' %>" required pattern="\d{10,15}" minlength="10" maxlength="15" title="Enter 10 to 15 digit phone number" autocomplete="tel">
                 </div>
                 <div class="form-group">
                    <label for="checkout-pincode" class="form-label small">Pincode:</label> <%# Changed ID %>
                    <input type="text"
                           id="checkout-pincode"
                           name="pincode"
                           class="form-control pincode-input" <%# Added pincode-input class %>
                           data-target-prefix="checkout" <%# Data attribute to target related fields %>
                           value="<%= userAddress?.pincode || '' %>"
                           required
                           pattern="\d{6}"
                           maxlength="6"
                           inputmode="numeric"
                           title="Enter 6-digit Pincode"
                           autocomplete="postal-code">
                    <small class="pincode-status text-muted"></small> <%# Area for loading/error messages %>
                </div>

                <%# Auto-filled Fields Container %>
                <%# The inline style below IS CORRECT for EJS. Linters might flag it, but it works. %>
                <div class="auto-filled-fields-container mb-2" id="checkout-auto-filled-fields" style="<%= (userAddress && userAddress.state) ? 'display: block;' : 'display: none;' %>"> <%# Show if data exists %>
                    <div class="form-group">
                       <label for="checkout-mandal" class="form-label small">Mandal / Taluk:</label>
                       <input type="text" id="checkout-mandal" class="form-control auto-filled-field" value="<%= userAddress?.mandal || '' %>" readonly tabindex="-1"> <%# Display initial value %>
                   </div>
                    <div class="form-group">
                       <label for="checkout-district" class="form-label small">District:</label>
                       <input type="text" id="checkout-district" class="form-control auto-filled-field" value="<%= userAddress?.district || '' %>" readonly tabindex="-1"> <%# Display initial value %>
                   </div>
                   <div class="form-group">
                       <label for="checkout-state" class="form-label small">State:</label>
                       <input type="text" id="checkout-state" class="form-control auto-filled-field" value="<%= userAddress?.state || '' %>" readonly tabindex="-1"> <%# Display initial value %>
                   </div>
                </div>

                <%# Hidden Inputs to Submit Derived Data %>
                <input type="hidden" id="checkout-mandal-hidden" name="mandal" value="<%= userAddress?.mandal || '' %>">
                <input type="hidden" id="checkout-district-hidden" name="district" value="<%= userAddress?.district || '' %>">
                <input type="hidden" id="checkout-state-hidden" name="state" value="<%= userAddress?.state || '' %>">

                <div class="form-group">
                    <label for="checkout-cityVillage" class="form-label small">City / Village / Area:</label> <%# Changed ID & Label %>
                    <input type="text" id="checkout-cityVillage" name="cityVillage" class="form-control" value="<%= userAddress?.cityVillage || '' %>" required autocomplete="address-line1">
                </div>
                 <div class="form-group">
                    <label for="checkout-landmarkNearby" class="form-label small">House No. / Building / Landmark (Optional):</label> <%# Changed ID & Label %>
                    <input type="text" id="checkout-landmarkNearby" name="landmarkNearby" class="form-control" value="<%= userAddress?.landmarkNearby || '' %>" autocomplete="address-line2">
                 </div>
                <button type="submit" class="btn btn-primary me-2">Save Address</button>
                 <%# Only show Cancel Edit button if editing existing address %>
                 <button type="button" id="cancel-edit-btn" class="btn btn-secondary <%= (!userAddress || !userAddress.name) ? 'hidden' : '' %>">Cancel Edit</button>
             </form>
        </div>

         <div class="checkout-summary">
             <h2>Order Summary</h2>
             <div class="checkout-items">
                 <% items.forEach(item => { %>
                    <div class="checkout-item">
                         <a href="/products/<%= item.productId %>" class="checkout-item-image">
                            <img src="<%= item.imageUrl %>" alt="<%= item.name %>">
                        </a>
                        <div class="checkout-item-info">
                             <%= item.name %> (Qty: <%= item.quantity %>)
                        </div>
                        <div class="checkout-item-price">₹<%= item.itemTotal.toFixed(2) %></div>
                     </div>
                <% }) %>
            </div>
            <hr>
            <div class="checkout-totals">
                <p>Subtotal: <span>₹<%= subTotal.toFixed(2) %></span></p>
                 <p>Shipping: <span>FREE</span></p>
                <hr>
                 <p><strong>Total: <span>₹<%= totalAmount.toFixed(2) %></span></strong></p>
            </div>

            <div class="checkout-payment">
                <h3>Payment Method</h3>
                 <div class="payment-option selected">
                     <input type="radio" id="cod" name="paymentMethodValue" value="COD" checked disabled>
                     <label for="cod"><i class="fas fa-money-bill-wave"></i> Cash on Delivery (COD)</label>
                 </div>
            </div>

            <form action="/orders/place" method="POST" class="place-order-form form-submit-spinner">
                 <input type="hidden" name="paymentMethod" value="COD">
                 <button type="submit" class="btn btn-success btn-block btn-place-order" <%= (!userAddress || !userAddress.name) ? 'disabled' : '' %>>
                    Place Order
                 </button>
                 <% if (!userAddress || !userAddress.name) { %>
                    <p class="text-danger small">Please add/save your shipping address first.</p>
                 <% } %>
             </form>
         </div>
    </div>
</div>

<%- include('../partials/footer') %>