<%# views/user/cart.ejs %>
<%- include('../partials/header', { title: 'Shopping Cart' }) %>

<div class="cart-container">
    <h1>Your Shopping Cart</h1>

    <% if (cart.length > 0) { %>
        <div class="cart-items">
            <% cart.forEach(item => { %>
                <div class="cart-item" data-product-id="<%= item.productId %>">
                    <div class="cart-item-image">
                        <a href="/products/<%= item.productId %>"><img src="<%= item.imageUrl %>" alt="<%= item.name %>"></a>
                    </div>
                    <div class="cart-item-details">
                        <h3 class="cart-item-name"><%= item.name %></h3>
                        <p class="cart-item-price">₹<%= (typeof item.price === 'number' ? item.price : 0).toFixed(2) %></p>
                        <p class="cart-item-stock">Stock: <%= item.stock %></p>
                    </div>

                    <%# --- UPDATED Quantity Control --- %>
                    <div class="cart-item-quantity">
                        <button type="button"
                                class="btn btn-qty-decrease"
                                data-product-id="<%= item.productId %>"
                                aria-label="Decrease quantity for <%= item.name %>"
                                <%= item.quantity <= 1 ? 'disabled' : '' %>>
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="text" <%# Change type to text, style as display %>
                               id="quantity-<%= item.productId %>"
                               class="quantity-display" <%# New class for styling %>
                               value="<%= item.quantity %>"
                               readonly <%# Make it read-only %>
                               aria-live="polite" <%# Announce changes to screen readers %>
                               data-stock="<%= item.stock %>" <%# Store stock here too %>
                               data-product-id="<%= item.productId %>">
                        <button type="button"
                                class="btn btn-qty-increase"
                                data-product-id="<%= item.productId %>"
                                aria-label="Increase quantity for <%= item.name %>"
                                <%= item.quantity >= item.stock ? 'disabled' : '' %>>
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <%# --- END UPDATED Quantity Control --- %>

                     <div class="cart-item-subtotal">
                         Subtotal: ₹<span class="item-subtotal-value"><%= (typeof item.subtotal === 'number' ? item.subtotal : 0).toFixed(2) %></span>
                    </div>
                    <div class="cart-item-remove">
                        <form action="/user/cart/remove/<%= item.productId %>" method="POST" class="form-submit-spinner">
                            <button type="submit" class="btn btn-danger btn-sm">× Remove</button>
                         </form>
                     </div>
                </div>
            <% }) %>
        </div>

         <div class="cart-summary">
             <h2>Cart Total: ₹<span id="cart-total-value"><%= (typeof cartTotal === 'number' ? cartTotal : 0).toFixed(2) %></span></h2>
             <a href="/user/checkout" class="btn btn-success btn-checkout">Proceed to Checkout</a>
        </div>

    <% } else { %>
        <p>Your cart is empty. <a href="/">Continue Shopping</a></p>
    <% } %>
</div>

 <%- include('../partials/footer') %>