<% if (products.length > 0) { %>
    <p class="text-muted mb-3">Review products submitted by sellers. Approved products will be visible on the site.</p>
    <div class="table-container card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Seller</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Submitted/Updated</th>
                    <th class="actions-cell" style="text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                <% products.forEach(product => { %>
                    <tr class="status-pending">
                        <td data-label="Image">
                            <a href="/admin/manage-products/edit/<%= product._id %>" title="View/Edit Product Details">
                                <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="table-img">
                            </a>
                            <br>
                            <a href="<%= product.imageUrl %>" target="_blank" rel="noopener noreferrer" class="btn-text btn-sm">[View Full Image]</a>
                        </td>
                        <td data-label="Name"><%= product.name %></td>
                        <td data-label="Seller"><%= product.sellerEmail %></td>
                        <td data-label="Category"><%= product.category %></td>
                        <td data-label="Price">â‚¹<%= product.price.toFixed(2) %></td>
                        <td data-label="Stock"><%= product.stock %></td>
                        <td data-label="Submitted/Updated"><%= formatDateIST(product.updatedAt) %></td>
                        <td data-label="Actions" class="actions-cell">
                            <!-- Approve Action -->
                            <form action="/admin/products/<%= product._id %>/approve" method="POST" class="inline-form form-submit-spinner">
                                <button type="submit" class="btn btn-success btn-sm" title="Approve Product">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            </form>

                            <!-- Reject Action (fixed using external script) -->
                            <form action="/admin/products/<%= product._id %>/reject" method="POST" class="inline-form form-submit-spinner"
                                  data-product-name="<%= product.name.replace(/"/g, '&quot;') %>"
                                  onsubmit="return handleRejectionPrompt(this)">
                                <input type="hidden" name="rejectionReason" value="">
                                <button type="submit" class="btn btn-danger btn-sm" title="Reject Product">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </form>

                            <!-- Edit Link -->
                            <a href="/admin/manage-products/edit/<%= product._id %>" class="btn btn-secondary btn-sm" title="Edit Product Details">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
<% } else { %>
    <p class="text-muted mt-3">There are no products currently awaiting review.</p>
<% } %>

<!-- External Script for Rejection Prompt -->
<script>
  function handleRejectionPrompt(form) {
    const productName = form.getAttribute('data-product-name');
    const reason = prompt(`Please enter the reason for rejecting ${productName}:`);
    if (!reason || reason.trim() === '') {
      alert('Rejection reason cannot be empty.');
      return false;
    }
    form.rejectionReason.value = reason.trim();
    return true;
  }
</script>
