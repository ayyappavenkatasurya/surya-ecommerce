<%# views/admin/edit-product.ejs %>
<%- include('../partials/header', { title: title }) %>

<div class="admin-manage-container">
    <h1><%= title %></h1>
    <p>Admin editing view for product originally uploaded by <%= product.sellerId ? product.sellerId.email : 'Unknown Seller' %>.</p>

    <form action="/admin/manage-products/update/<%= product._id %>" method="POST" class="form-submit-spinner">
        <div class="form-group">
            <label for="name">Product Name:</label>
            <input type="text" id="name" name="name" class="form-control" value="<%= product.name %>" required>
        </div>

        <%# --- MODIFIED: Category Dropdown --- %>
        <div class="form-group">
            <label for="categoryRef">Category:</label>
            <select id="categoryRef" name="categoryRef" class="form-control" required>
                <option value="" disabled>-- Select a Category --</option>
                 <% if (locals.categories && categories.length > 0) { %>
                    <% categories.forEach(cat => { %>
                        <%# IMPORTANT: Compare categoryRef._id if populated, otherwise compare strings %>
                        <% const currentCategoryId = product.categoryRef?._id?.toString() || product.categoryRef?.toString(); %>
                        <option value="<%= cat._id %>" <%= (currentCategoryId === cat._id.toString()) ? 'selected' : '' %>>
                             <%= cat.name %>
                         </option>
                    <% }) %>
                 <% } else { %>
                      <option value="" disabled>No categories available</option>
                  <% } %>
            </select>
             <% if (!locals.categories || categories.length === 0) { %>
                 <small class="text-danger d-block mt-1">Cannot update products without categories. Please <a href="/admin/manage-categories">add categories</a> first.</small>
             <% } %>
        </div>
        <%# --- End Modification --- %>

        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" class="form-control" rows="4"><%= product.description || '' %></textarea>
        </div>
        <div class="form-group">
            <label for="price">Price (â‚¹):</label>
            <input type="number" id="price" name="price" class="form-control" step="0.01" min="0" value="<%= product.price %>" required>
        </div>
        <div class="form-group">
            <label for="stock">Stock Quantity:</label>
            <input type="number" id="stock" name="stock" class="form-control" min="0" value="<%= product.stock %>" required>
        </div>
        <div class="form-group">
            <label for="imageUrl">Image URL:</label>
            <input type="url" id="imageUrl" name="imageUrl" class="form-control" value="<%= product.imageUrl %>" required>
            <% if (product.imageUrl) { %>
                <img src="<%= product.imageUrl %>" alt="Current Image" style="max-width: 100px; margin-top: 5px; border:1px solid #ccc; padding:2px;">
            <% } %>
        </div>
        <div class="form-group">
            <label for="specifications">Specifications:</label>
            <textarea id="specifications" name="specifications" class="form-control" rows="5"><%= product.specifications || '' %></textarea>
        </div>

        <hr>
        <h4>Admin Review Control</h4>
        <div class="form-group">
            <label for="reviewStatus">Review Status:</label>
            <select id="reviewStatus" name="reviewStatus" class="form-control" onchange="toggleRejectionReason(this.value)">
                <option value="pending" <%= product.reviewStatus === 'pending' ? 'selected' : '' %>>Pending</option>
                <option value="approved" <%= product.reviewStatus === 'approved' ? 'selected' : '' %>>Approved</option>
                <option value="rejected" <%= product.reviewStatus === 'rejected' ? 'selected' : '' %>>Rejected</option>
            </select>
        </div>
        <div class="form-group" id="rejectionReasonGroup" <%= product.reviewStatus !== 'rejected' ? 'style="display: none;"' : '' %>>
            <label for="rejectionReason">Rejection Reason (Required if Rejected):</label>
            <textarea id="rejectionReason" name="rejectionReason" rows="3" class="form-control"><%= product.rejectionReason || '' %></textarea>
        </div>

        <button type="submit" class="btn btn-primary" <%= (!locals.categories || categories.length === 0) ? 'disabled' : '' %>>
            Update Product (Admin)
        </button>
        <a href="/admin/manage-products" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
    function toggleRejectionReason(status) { /* Keep existing script */ }
    document.addEventListener('DOMContentLoaded', () => { /* Keep existing script */ });
</script>

<%- include('../partials/footer') %>