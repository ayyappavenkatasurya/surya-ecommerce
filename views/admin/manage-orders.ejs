<%# views/admin/manage-orders.ejs %>
<%- include('../partials/header', { title: title }) %>

<div class="admin-manage-container">
    <h1><%= title %></h1> <%# Title now passed from controller %>

    <% if (orders.length > 0) { %>
        <div class="table-container card">
            <table class="data-table">
                <thead>
                    <tr>
                        <%# Simplified headers for mobile-first data-label %>
                        <th>Details</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th class="actions-cell" style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% orders.forEach(order => { %>
                        <tr class="status-<%= order.status.toLowerCase().replace(/ /g, '-') %>" data-order-id="<%= order._id %>">
                             <td data-label="Details">
                                 <strong>ID:</strong> <%= order._id %><br>
                                 <small><%= formatDateIST(order.orderDate) %></small><br>
                                 <% if (order.products && order.products.length > 0 && order.products[0].productId && order.products[0].productId.sellerId) { %>
                                    <small>Seller(s) involved</small> <%# Example: Could list sellers if needed %>
                                 <% } %>
                                 <%# Removed image preview for cleaner mobile view, focus on data %>
                            </td>
                            <td data-label="Customer">
                                <%= order.shippingAddress.name %>
                                <br><small class="text-muted"><%= order.userEmail || order.userId?.email %></small> <%# Safer email access %>
                                <br><small><%= order.shippingAddress.cityVillage %>, <%= order.shippingAddress.pincode %></small>
                                <br><small><strong>Ph:</strong> <%= order.shippingAddress.phone %></small>
                            </td>
                             <td data-label="Items"> <%- order.itemsSummary %></td> <%# Use pre-formatted summary %>
                            <td data-label="Total"><strong>â‚¹<%= order.totalAmount.toFixed(2) %></strong></td>
                            <td data-label="Status">
                                <span class="status-badge status-<%= order.status.toLowerCase().replace(/ /g, '-') %>"><%= order.status %></span>
                                <% if(order.status === 'Cancelled' && order.cancellationReason) { %><br><small class="text-danger">Reason: <%= order.cancellationReason %></small><% } %>
                                <% if(order.status === 'Delivered' && order.receivedByDate) { %><br><small class="text-success">Delivered:<br><%= formatDateIST(order.receivedByDate) %></small><% } %>
                            </td>
                            <td data-label="Actions" class="actions-cell">
                                <%# Admin Direct Delivery Confirmation %>
                                <% if (order.canBeDirectlyDeliveredByAdmin) { %>
                                    <div class="action-group">
                                        <p class="action-group-title">Admin Direct Delivery:</p>
                                        <form action="/admin/orders/<%= order._id %>/send-direct-delivery-otp" method="POST" class="inline-form form-submit-spinner mb-1">
                                            <button type="submit" class="btn btn-warning btn-sm" title="Send OTP to customer for admin delivery">
                                                <i class="fas fa-mobile-alt"></i> Send OTP
                                            </button>
                                        </form>
                                        <form action="/admin/orders/<%= order._id %>/confirm-direct-delivery" method="POST" class="inline-form verify-otp-form form-submit-spinner">
                                            <input type="text" name="otp" placeholder="Enter OTP" required size="8" pattern="\d{6}" maxlength="6" inputmode="numeric" title="Enter 6-digit OTP from customer">
                                            <button type="submit" class="btn btn-success btn-sm" title="Confirm direct delivery">
                                                <i class="fas fa-check-double"></i> Confirm
                                            </button>
                                        </form>
                                    </div>
                                <% } %>

                                <%# Admin Order Cancellation %>
                                <% if (order.canBeCancelledByAdmin) { %>
                                    <div class="action-group">
                                        <form action="/admin/orders/<%= order._id %>/cancel" method="POST" class="inline-form cancel-delivery-form form-submit-spinner" onsubmit="return confirm('ADMIN ACTION: Are you sure you want to cancel order <%= order._id %>? This cannot be undone.');">
                                            <label for="reason-<%= order._id %>" class="action-group-title">Cancel Order:</label>
                                            <select name="reason" id="reason-<%= order._id %>" required class="form-control form-control-sm d-block mb-1"> <%# Style select better %>
                                                <option value="" disabled selected>Select Admin Reason...</option>
                                                <% cancellationReasons.forEach(reason => { %>
                                                    <option value="<%= reason %>"><%= reason %></option>
                                                <% }) %>
                                            </select>
                                            <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-ban"></i> Cancel Order</button>
                                        </form>
                                    </div>
                                <% } %>

                                <%# Fallback for no actions %>
                                <% if (!order.canBeDirectlyDeliveredByAdmin && !order.canBeCancelledByAdmin) { %>
                                    <small class="text-muted">
                                        <% if (order.status === 'Delivered') { %>Completed<% } else if (order.status === 'Cancelled') { %>Cancelled<% } else { %>No admin actions<% } %>
                                    </small>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    <% } else { %>
        <p>No orders received yet.</p>
    <% } %>
</div>

<%- include('../partials/footer') %>