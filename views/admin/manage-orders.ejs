<%# views/admin/manage-orders.ejs %>
<%- include('../partials/header', { title: 'Manage Orders' }) %>

<div class="admin-manage-container">
    <h1>Manage Orders</h1>

    <% if (orders.length > 0) { %>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Customer</th>
                     <th>Address & Phone</th> <%# Combined Header %>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status & Assignment</th> <%# Combined Header %>
                    <th>Actions</th>
                </tr>
             </thead>
            <tbody>
                <% orders.forEach(order => { %>
                    <tr class="status-<%= order.status.toLowerCase().replace(/ /g, '-') %>">
                        <td data-label="Image">
                            <%# Use primaryImageUrl added in controller %>
                            <% if (order.primaryImageUrl) { %>
                                <a href="/products/<%= order.products[0].productId %>">
                                    <img src="<%= order.primaryImageUrl %>" alt="<%= order.products[0].name %>" class="table-img">
                                </a>
                            <% } else { %> <span class="text-muted">N/A</span> <% } %>
                        </td>
                        <td data-label="Order ID"><%= order._id %></td>
                         <td data-label="Date"><%= order.formattedOrderDate %></td>
                         <td data-label="Customer"><%= order.userEmail %></td>
                         <td data-label="Address & Phone"> <%# Use Data Label %>
                            <%= order.shippingAddress.name %>, <%= order.shippingAddress.cityVillage %>, <%= order.shippingAddress.pincode %>
                            <br><strong>Ph: <%= order.shippingAddress.phone %></strong>
                         </td>
                        <td data-label="Items">
                            <% if (order.products && order.products.length > 0) { %>
                                <%= order.products[0].name %> (x<%= order.products[0].quantity %>)
                                <% if (order.products.length > 1) { %><br><small>+ <%= order.products.length - 1 %> more item(s)</small><% } %>
                            <% } else { %> No items found <% } %>
                         </td>
                        <td data-label="Total">â‚¹<%= order.totalAmount.toFixed(2) %></td>
                        <td data-label="Status & Assignment"> <%# Use Data Label %>
                             <span class="status-badge status-<%= order.status.toLowerCase().replace(/ /g, '-') %>"><%= order.status %></span> <%# Add status class %>
                            <% if(order.assignedAdminEmail) { %>
                                <br><small>(Assigned: <%= order.assignedAdminEmail %>)</small>
                            <% } %>
                            <% if(order.status === 'Cancelled' && order.cancellationReason) { %><br><small class="text-danger">Reason: <%= order.cancellationReason %></small><% } %>
                            <% if(order.status === 'Delivered' && order.formattedReceivedDate) { %><br><small class="text-success">Delivered: <%= order.formattedReceivedDate %></small><% } %>
                        </td>
                        <td data-label="Actions" class="actions-cell"> <%# Keep actions-cell for styling %>

                            <%# --- Direct Delivery Confirmation by Admin (Pending orders) --- %>
                            <% if (order.canBeDirectlyDeliveredByAdmin) { %>
                                 <div class="action-group">
                                     <p class="action-group-title">Admin Direct Delivery:</p>
                                    <form action="/admin/orders/<%= order._id %>/send-direct-delivery-otp" method="POST" class="inline-form form-submit-spinner">
                                        <button type="submit" class="btn btn-warning btn-sm" title="Send delivery confirmation OTP to customer for direct delivery">
                                            <i class="fas fa-mobile-alt"></i> Send OTP
                                        </button>
                                    </form>
                                    <form action="/admin/orders/<%= order._id %>/confirm-direct-delivery" method="POST" class="inline-form verify-otp-form form-submit-spinner">
                                        <input type="text" name="otp" placeholder="6-Digit OTP" required size="8" pattern="\d{6}" maxlength="6" inputmode="numeric" title="Enter the 6-digit OTP from customer">
                                        <button type="submit" class="btn btn-success btn-sm" title="Confirm direct delivery">
                                            <i class="fas fa-check-double"></i> Confirm
                                        </button>
                                    </form>
                                </div>
                            <% } %>

                            <%# --- Assign Order to Delivery Admin (Pending orders) --- %>
                            <% if (order.canBeAssignedByAdmin) { %>
                                <div class="action-group">
                                    <p class="action-group-title">Assign for Delivery:</p>
                                     <% if (deliveryAdmins && deliveryAdmins.length > 0) { %>
                                        <form action="/admin/orders/<%= order._id %>/assign" method="POST" class="inline-form assign-order-form form-submit-spinner">
                                            <select name="deliveryAdminId" required class="form-control form-control-sm">
                                                <option value="" disabled selected>Assign to...</option>
                                                <% deliveryAdmins.forEach(admin => { %>
                                                    <option value="<%= admin._id %>">
                                                        <%= admin.email %> <% if (admin.address && admin.address.phone) { %>(<%= admin.address.phone %>)<% } %>
                                                    </option>
                                                <% }) %>
                                            </select>
                                            <button type="submit" class="btn btn-info btn-sm">
                                                <i class="fas fa-shipping-fast"></i> Assign
                                            </button>
                                        </form>
                                     <% } else { %>
                                         <small class="text-danger d-block">No delivery admins available.</small>
                                     <% } %>
                                </div>
                            <% } %>

                             <%# --- NEW: Unassign Order from Delivery Admin (Out for Delivery orders) --- %>
                            <% if (order.canBeUnassignedByAdmin) { %>
                                <div class="action-group">
                                     <p class="action-group-title">Unassign Delivery:</p>
                                     <form action="/admin/orders/<%= order._id %>/unassign" method="POST" class="inline-form form-submit-spinner" onsubmit="return confirm('Are you sure you want to unassign this order from <%= order.assignedAdminEmail %>? It will return to Pending status.');">
                                        <button type="submit" class="btn btn-secondary btn-sm" title="Return order to Pending queue">
                                             <i class="fas fa-undo"></i> Unassign
                                         </button>
                                    </form>
                                </div>
                             <% } %>
                            <%# --- END: Unassign --- %>

                            <%# --- Cancel Order (Admin: Pending or Out for Delivery) --- %>
                            <% if (order.canBeCancelledByAdmin) { %>
                                <div class="action-group">
                                    <form action="/admin/orders/<%= order._id %>/cancel" method="POST" class="inline-form cancel-delivery-form form-submit-spinner" onsubmit="return confirm('Are you sure you want to cancel this order? This cannot be undone.');">
                                        <label for="reason-<%= order._id %>" class="action-group-title">Cancel Order:</label>
                                        <select name="reason" id="reason-<%= order._id %>" required class="form-control form-control-sm">
                                            <option value="" disabled selected>Select Reason...</option>
                                            <% cancellationReasons.forEach(reason => { %>
                                                <option value="<%= reason %>"><%= reason %></option>
                                            <% }) %>
                                        </select>
                                        <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-ban"></i> Cancel Order</button>
                                    </form>
                                </div>
                            <% } %>

                            <%# Fallback for Completed/Cancelled states where no other actions apply %>
                            <% if (!order.canBeDirectlyDeliveredByAdmin && !order.canBeAssignedByAdmin && !order.canBeUnassignedByAdmin && !order.canBeCancelledByAdmin) { %>
                                <% if (order.status === 'Delivered') { %>
                                    <small class="text-success">Completed.</small>
                                <% } else if (order.status === 'Cancelled') { %>
                                    <small class="text-danger">Cancelled.</small>
                                <% } else { %>
                                    <small class="text-muted">No actions available.</small> <%# Should not happen often %>
                                <% } %>
                            <% } %>

                         </td>
                    </tr>
                <% }) %>
             </tbody>
        </table>
    <% } else { %>
        <p>No orders received yet.</p>
    <% } %>
</div>

<%- include('../partials/footer') %>