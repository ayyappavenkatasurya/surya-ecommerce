<%# views/admin/manage-orders.ejs %>
<%- include('../partials/header', { title: 'Manage Orders' }) %>

<div class="admin-manage-container">
    <h1>Manage Orders</h1>

    <% if (orders.length > 0) { %>
        <div class="table-container card">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Images</th>
                        <th>Order ID</th>
                        <th>Date</th>
                        <%# Show Customer Email only for Admin %>
                        <% if (userRole === 'admin') { %><th>Customer Email</th><% } %>
                        <th>Customer & Address</th>
                        <th>Items & Prices</th>
                        <th>Total</th>
                        <th>Status</th>
                        <%# Show Actions column only for Admin %>
                        <% if (userRole === 'admin') { %><th class="actions-cell" style="text-align: right;">Actions</th><% } %>
                    </tr>
                </thead>
                <tbody>
                    <% orders.forEach(order => { %>
                        <tr class="status-<%= order.status.toLowerCase().replace(/ /g, '-') %>" data-order-id="<%= order._id %>">
                            <td data-label="Images">
                                <% if (order.products && order.products.length > 0) { %>
                                    <% order.products.slice(0, 3).forEach(item => { %>
                                        <% if (item.productId && item.productId._id && item.imageUrl) { %>
                                            <%# Link only if product exists (it should based on population) %>
                                            <a href="/products/<%= item.productId._id %>" title="View Product: <%= item.productId.name %>">
                                                <img src="<%= item.imageUrl %>" alt="<%= item.productId.name %>" class="table-img">
                                            </a>
                                        <% } else { %><span class="text-muted" style="font-size: 0.8em;">[?]</span><% } %>
                                    <% }) %>
                                    <% if (order.products.length > 3) { %><br><small class="text-muted" style="white-space: nowrap;">+ <%= order.products.length - 3 %> more</small><% } %>
                                <% } else { %><span class="text-muted">N/A</span><% } %>
                            </td>
                            <td data-label="Order ID"><%= order._id %></td>
                            <td data-label="Date"><%= formatDateIST(order.orderDate) %></td>
                            <%# Conditional Customer Email %>
                            <% if (userRole === 'admin') { %><td data-label="Customer Email"><%= order.userEmail %></td><% } %>
                            <td data-label="Customer & Address">
                                <%= order.shippingAddress.name %>, <%= order.shippingAddress.cityVillage %>, <%= order.shippingAddress.pincode %>
                                <br><strong>Ph: <%= order.shippingAddress.phone %></strong>
                            </td>
                            <td data-label="Items & Prices">
                                <%- order.itemsSummary %> <%# Use pre-formatted summary %>
                            </td>
                            <td data-label="Total"><strong>â‚¹<%= order.totalAmount.toFixed(2) %></strong></td>
                            <td data-label="Status">
                                <span class="status-badge status-<%= order.status.toLowerCase().replace(/ /g, '-') %>"><%= order.status %></span>
                                <% if(order.status === 'Cancelled' && order.cancellationReason) { %><br><small class="text-danger">Reason: <%= order.cancellationReason %></small><% } %>
                                <% if(order.status === 'Delivered' && order.receivedByDate) { %><br><small class="text-success">Delivered: <%= formatDateIST(order.receivedByDate) %></small><% } %>
                            </td>
                            <%# --- Admin Actions --- %>
                            <% if (userRole === 'admin') { %>
                            <td data-label="Actions" class="actions-cell">
                                <%# Direct Delivery Actions (Admin Only) %>
                                <% if (order.canBeDirectlyDeliveredByAdmin) { %>
                                    <div class="action-group">
                                        <p class="action-group-title">Admin Direct Delivery:</p>
                                        <form action="/admin/orders/<%= order._id %>/send-direct-delivery-otp" method="POST" class="inline-form form-submit-spinner">
                                            <button type="submit" class="btn btn-warning btn-sm" title="Send delivery confirmation OTP to customer for direct delivery">
                                                <i class="fas fa-mobile-alt"></i> Send OTP
                                            </button>
                                        </form>
                                        <form action="/admin/orders/<%= order._id %>/confirm-direct-delivery" method="POST" class="inline-form verify-otp-form form-submit-spinner">
                                            <input type="text" name="otp" placeholder="6-Digit OTP" required size="8" pattern="\d{6}" maxlength="6" inputmode="numeric" title="Enter the 6-digit OTP from customer">
                                            <button type="submit" class="btn btn-success btn-sm" title="Confirm direct delivery">
                                                <i class="fas fa-check-double"></i> Confirm
                                            </button>
                                        </form>
                                    </div>
                                <% } %>

                                <%# Cancel Order Action (Admin Only) %>
                                <% if (order.canBeCancelledByAdmin) { %>
                                    <div class="action-group">
                                        <form action="/admin/orders/<%= order._id %>/cancel" method="POST" class="inline-form cancel-delivery-form form-submit-spinner" onsubmit="return confirm('Are you sure you want to cancel this order? This cannot be undone.');">
                                            <label for="reason-<%= order._id %>" class="action-group-title">Cancel Order:</label>
                                            <select name="reason" id="reason-<%= order._id %>" required class="form-control form-control-sm">
                                                <option value="" disabled selected>Select Reason...</option>
                                                <% cancellationReasons.forEach(reason => { %>
                                                    <option value="<%= reason %>"><%= reason %></option>
                                                <% }) %>
                                            </select>
                                            <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-ban"></i> Cancel Order</button>
                                        </form>
                                    </div>
                                <% } %>

                                <%# Fallback Text when no actions are available %>
                                <% if (!order.canBeDirectlyDeliveredByAdmin && !order.canBeCancelledByAdmin) { %>
                                    <% if (order.status === 'Delivered') { %><small class="text-success">Completed.</small><% } else if (order.status === 'Cancelled') { %><small class="text-danger">Cancelled.</small><% } else { %><small class="text-muted">No actions available.</small><% } %>
                                <% } %>
                            </td>
                            <% } %> <%# End Admin Role Check for Actions Column %>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    <% } else { %>
        <p>No orders found matching your criteria.</p>
    <% } %>
</div>

<%- include('../partials/footer') %>