<%# views/admin/manage-products.ejs %>
<%- include('../partials/header', { title: title }) %>

<div class="admin-manage-container">
    <h1><%= title %></h1>
    <a href="/admin/upload-product" class="btn btn-primary mb-3"><i class="fas fa-plus"></i> Upload New Product</a>

   <% if (products.length > 0) { %>
       <div class="table-container card">
           <table class="data-table">
               <thead>
                   <tr>
                       <th>Image</th>
                       <th>Name</th>
                       <% if (userRole === 'admin') { %><th>Seller</th><% } %> <%# Show Seller only for Admin %>
                       <th>Category</th>
                       <th>Price</th>
                       <th>Stock</th>
                       <th>Sold</th>
                       <th>Rating</th>
                       <th>Status</th> <%# NEW Column %>
                       <th class="actions-cell" style="text-align: right;">Actions</th>
                   </tr>
                </thead>
                <tbody>
                   <% products.forEach(product => { %>
                       <%# Determine row class based on status %>
                       <%
                          let statusClass = '';
                          if (product.status === 'Pending Review') statusClass = 'status-pending';
                          else if (product.status === 'Rejected') statusClass = 'status-cancelled'; // Using cancelled style for rejected
                          else if (product.status === 'Approved') statusClass = 'status-delivered'; // Using delivered style for approved
                       %>
                       <tr class="<%= statusClass %>">
                           <td data-label="Image">
                               <a href="/products/<%= product._id %>" title="View product (if approved)">
                                   <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="table-img">
                               </a>
                           </td>
                            <td data-label="Name"><%= product.name %></td>
                           <% if (userRole === 'admin') { %><td data-label="Seller"><%= product.sellerEmail %></td><% } %>
                            <td data-label="Category"><%= product.category %></td>
                            <td data-label="Price">â‚¹<%= product.price.toFixed(2) %></td>
                            <td data-label="Stock"><%= product.stock %></td>
                            <td data-label="Sold"><%= product.orderCount %></td>
                            <td data-label="Rating"><%= product.averageRating.toFixed(1) %> (<%= product.numReviews %>)</td>
                           <%# --- Status Column --- %>
                           <td data-label="Status">
                                <span class="status-badge <%= statusClass %>"><%= product.status %></span>
                                <% if (product.status === 'Rejected' && product.rejectionReason) { %>
                                    <br><small class="text-danger" title="<%= product.rejectionReason %>">Reason: <%= product.rejectionReason.substring(0, 30) %><% if (product.rejectionReason.length > 30) { %>...<% } %></small>
                                <% } %>
                            </td>
                           <%# --- End Status Column --- %>
                            <td data-label="Actions" class="actions-cell">
                               <%# Edit Button %>
                               <a href="/admin/manage-products/edit/<%= product._id %>" class="btn btn-text btn-sm" title="Edit"><i class="fas fa-edit"></i></a>

                               <%# Remove Button (Confirm handled by JS) %>
                               <form action="/admin/manage-products/remove/<%= product._id %>" method="POST" class="inline-form form-submit-spinner" onsubmit="return confirm('Are you sure you want to remove this product: <%= product.name %>?');">
                                    <button type="submit" class="btn btn-text btn-danger btn-sm" title="Remove"><i class="fas fa-trash"></i></button>
                               </form>

                                <%# Admin-specific Review Actions (Directly from Manage page if needed) %>
                                <% if (userRole === 'admin' && product.status === 'Pending Review') { %>
                                    <form action="/admin/products/<%= product._id %>/approve" method="POST" class="inline-form form-submit-spinner">
                                        <button type="submit" class="btn btn-success btn-sm" title="Approve"><i class="fas fa-check"></i></button>
                                    </form>
                                    <%# Quick Reject (Might want a modal for reason here) %>
                                    <form action="/admin/products/<%= product._id %>/reject" method="POST" class="inline-form form-submit-spinner" onsubmit="const reason = prompt('Enter rejection reason:'); if (!reason) return false; this.rejectionReason.value = reason;">
                                         <input type="hidden" name="rejectionReason" value="">
                                        <button type="submit" class="btn btn-warning btn-sm" title="Reject"><i class="fas fa-times"></i></button>
                                    </form>
                                <% } %>
                           </td>
                        </tr>
                    <% }) %>
               </tbody>
            </table>
       </div>
   <% } else { %>
        <p class="text-muted mt-3">
            <% if (userRole === 'seller') { %>
                You haven't uploaded any products yet. <a href="/admin/upload-product">Upload your first product!</a>
            <% } else { %>
                No products found in the system. <a href="/admin/upload-product">Upload the first product!</a>
            <% } %>
        </p>
   <% } %>
</div>

<%- include('../partials/footer') %>