<%# views/delivery/assigned-orders-detail.ejs %>
<%- include('../partials/header', { title: title }) %>

<div class="delivery-orders-detail-container admin-manage-container">
    <h1><%= title %></h1>
     <p><a href="/delivery/dashboard">« Back to Delivery Dashboard</a></p>

    <% if (orders.length > 0) { %>
        <table class="data-table">
            <thead>
                <tr>
                     <th>Image</th>
                     <th>Order ID</th>
                     <th>Placed Date</th>
                    <th>Customer</th>
                     <th>Address & Phone</th>
                    <th>Items</th>
                    <th>Order Total</th> <%# <-- ADDED HEADER %>
                     <th>Status</th>
                     <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% orders.forEach(order => { %>
                    <tr class="status-<%= order.status.toLowerCase().replace(/ /g, '-') %>">
                        <td data-label="Image"> <%# Added data-label %>
                            <% if (order.products && order.products.length > 0 && order.products[0].imageUrl) { %>
                                <a href="/products/<%= order.products[0].productId %>">
                                    <img src="<%= order.products[0].imageUrl %>" alt="<%= order.products[0].name %>" class="table-img">
                                </a>
                            <% } else { %> <span class="text-muted">N/A</span> <% } %>
                        </td>
                         <td data-label="Order ID"><%= order._id %></td> <%# Added data-label %>
                         <td data-label="Placed Date"><%= order.formattedOrderDate %></td> <%# Added data-label %>
                         <td data-label="Customer"><%= order.shippingAddress.name %></td> <%# Added data-label %>
                         <td data-label="Address & Phone"> <%# Added data-label %>
                            <%= order.shippingAddress.cityVillage %>, <%= order.shippingAddress.pincode %>
                             <br><strong>Ph: <%= order.shippingAddress.phone %></strong>
                             <% if (order.shippingAddress.landmarkNearby) { %><br><small>Landmark: <%= order.shippingAddress.landmarkNearby %></small><% } %>
                        </td>
                         <td data-label="Items"> <%# Added data-label %>
                            <% if (order.products && order.products.length > 0) { %>
                                <%= order.products[0].name %> (x<%= order.products[0].quantity %>)
                                <% if (order.products.length > 1) { %><br><small>+ <%= order.products.length - 1 %> more item(s)</small><% } %>
                            <% } else { %> No items found <% } %>
                        </td>
                        <%# --- ADDED CELL for Total Amount --- %>
                        <td data-label="Order Total"><strong>₹<%= order.totalAmount.toFixed(2) %></strong></td>
                        <%# --- END ADDED CELL --- %>
                        <td data-label="Status"> <%# Added data-label %>
                            <span class="status-badge status-<%= order.status.toLowerCase().replace(/ /g, '-') %>"><%= order.status %></span> <%# Added status class %>
                            <% if(order.status === 'Delivered' && order.formattedReceivedDate) { %><br><small>(Delivered: <%= order.formattedReceivedDate %>)</small><% } %>
                            <% if(order.status === 'Cancelled' && order.cancellationReason) { %><br><small class="text-danger">Reason: <%= order.cancellationReason %></small><% } %>
                         </td>
                        <td data-label="Actions" class="actions-cell"> <%# Added data-label %>
                            <%# --- Delivery OTP Controls --- %>
                            <% if (order.canRequestDeliveryOtp) { %>
                                <div class="action-group"> <%# Wrapped in action-group %>
                                    <p class="action-group-title">Confirm Delivery:</p> <%# Optional title %>
                                    <form action="/delivery/orders/<%= order._id %>/send-delivery-otp" method="POST" class="inline-form form-submit-spinner">
                                        <button type="submit" class="btn btn-warning btn-sm" title="Send OTP to customer"><i class="fas fa-mobile-alt"></i> Send OTP</button>
                                    </form>
                                    <form action="/delivery/orders/<%= order._id %>/verify-delivery-otp" method="POST" class="inline-form verify-otp-form form-submit-spinner">
                                        <input type="text" <%# Changed type to text %>
                                               inputmode="numeric" <%# Suggest numeric keyboard %>
                                               name="otp"
                                               placeholder="6-Digit OTP"
                                               required
                                               size="8"
                                               maxlength="6" <%# Max length 6 %>
                                               pattern="\d{6}" <%# Exactly 6 digits %>
                                               autocomplete="one-time-code" <%# Helper attribute %>
                                               title="Enter 6-digit OTP from customer" <%# Clear hint %>
                                               class="form-control form-control-sm"> <%# Basic styling %>
                                        <button type="submit" class="btn btn-success btn-sm" title="Confirm delivery"><i class="fas fa-check-double"></i> Confirm</button>
                                    </form>
                                </div>
                            <% } %>

                            <%# --- Cancel Assigned Order (Delivery Admin) --- %>
                             <% if (order.canBeCancelledByDelivery) { %>
                                <div class="action-group"> <%# Wrapped in action-group %>
                                    <form action="/delivery/orders/<%= order._id %>/cancel-delivery" method="POST" class="inline-form cancel-delivery-form form-submit-spinner" onsubmit="return confirm('Are you sure you want to cancel this delivery? This cannot be undone.');">
                                         <label for="reason-<%= order._id %>" class="action-group-title">Cancel Delivery:</label> <%# Label acts as title %>
                                         <select name="reason" id="reason-<%= order._id %>" required class="form-control form-control-sm"> <%# Basic styling %>
                                             <option value="" disabled selected>Select Reason...</option>
                                             <% cancellationReasons.forEach(reason => { %>
                                                 <option value="<%= reason %>"><%= reason %></option>
                                             <% }) %>
                                         </select>
                                        <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-ban"></i> Cancel</button>
                                     </form>
                                </div>
                             <% } %>

                             <%# --- Unassign Order (Delivery Admin) --- %>
                             <% if (order.canBeUnassignedByDelivery) { %>
                                 <div class="action-group"> <%# Wrapped in action-group %>
                                     <p class="action-group-title">Return to Admin:</p> <%# Optional title %>
                                     <form action="/delivery/orders/<%= order._id %>/unassign" method="POST" class="inline-form form-submit-spinner" onsubmit="return confirm('Are you sure you want to unassign this order? It will return to the admin pool.');">
                                         <button type="submit" class="btn btn-outline-secondary btn-sm"><i class="fas fa-undo"></i> Unassign</button>
                                     </form>
                                 </div>
                             <% } %>

                            <%# --- Fallback messages for other statuses --- %>
                             <% if (!order.canRequestDeliveryOtp && !order.canBeCancelledByDelivery && !order.canBeUnassignedByDelivery) { %>
                                 <% if (order.status === 'Pending' || order.status === 'Order Received') { %>
                                    <small class="text-muted">Waiting for processing.</small>
                                <% } else if (order.status === 'Delivered') { %>
                                    <small class="text-success">Completed.</small>
                                <% } else if (order.status === 'Cancelled') { %>
                                    <% if (!order.cancellationReason) { %>
                                        <small class="text-danger">Cancelled.</small>
                                    <% } %>
                                <% } else { %>
                                    <small class="text-muted">No actions available.</small>
                                <% } %>
                             <% } %>
                         </td>
                    </tr>
                <% }) %>
            </tbody>
         </table>
     <% } else { %>
         <p>No orders found matching this criteria.</p>
     <% } %>
</div>

<%- include('../partials/footer') %>